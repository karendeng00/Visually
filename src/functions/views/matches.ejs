<!DOCTYPE html>
<html>
<head>
  <title>Match</title>
	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	
	<link rel="stylesheet" type="text/css" href="./../styles.css">

	<!--  scripts for general website format-->  
  	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
	
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	
    <!--   	handlebars for templating-->   
	<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.4.2/handlebars.js"></script> 
	 <script src="./handlebars.js"></script> <!-- helper function here -->

	
	  <!-- Icons -->
	  <script src="https://kit.fontawesome.com/862904df26.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
</head>
	
<body>
  <nav class="navbar navbar-default navbar-expand-lg fixed-top">
      <a class="navbar-brand" href="#">Spotify316</a>
	  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"><i class="fa fa-reorder" style="color:white"></i>
	  </button>
	  <div class="collapse navbar-collapse" id="navbarNav">
		  <ul class="navbar-nav ml-auto">
			<li class="nav-item active"><a class="nav-link" href="./matches" style="color: white !important">Matches</a></li>
			<li class="nav-item"><a class="nav-link" href="#" style="color: white !important">Discover</a></li>
			<li class="nav-item"><a class="nav-link" href="/index.html" style="color: white !important"><i class="fas fa-user" style="color: white"></i> Profile</a></li>
			<li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-comment-dots" style="color: white"></i></a></li>
			<li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-bell" style="color: white"></i></a></li>
		  </ul>		  
	  </div>
    </nav>
	
	<div class="center-pane-margin">
		<div class="container">
<!--			<h1 class="gradient-text">Find your musical match!</h1>-->
			
			<div class="sidebar-match">
				<h3>Compare</h3>
				<canvas id="myChart" width="400" height="400"></canvas>
			</div>
			<div class="mainbar">
				<div class="row">
					<div class="card-deck">
						<% users.forEach(function(user) { %>
					 	<div class="col-lg-3" style="margin:0px 0px 5px 0px !important; padding:0px !important;">
							<div class="card text-center" style="border-radius: 25px; overflow:hidden; margin: 5px; box-shadow: 0 3px 5px 0 rgba(0, 0, 0, 0.07), 0 6px 20px 0 rgba(0, 0, 0, 0.07);"> <!-- border: 1px solid #ff2323; -->
									<img class="card-img-top" src="<%= user.user_info.image %>" alt=" Profile Image" style="min-height:190px;">
									<h3 style="color: #ff2323; padding-top: 10px;">90%</h3>
								<div class="card-body" style="padding-top:0px !important;">
									<h5 class="card-title"><%= user.user_info.name %></h5>
<!--									<a href="<%= user.url %>"><i class="fab fa-spotify" style="color:#1DB954"></i></a>-->
									<p>Recent track valence: <%= user.recent_tracks.agg_features.valence %></p>
									<p>Top track instr: <%= user.top_tracks.agg_features.danceability %></p>
									<button type="button" class="btn btn-lightred btn-primary btn-sm">Compare</button>
									<button type="button" name="follow" class="btn btn-lightred btn-primary btn-sm"><i class='fas fa-user-plus' style='color:white'></i></button>
								</div>
							</div>	
						</div>
						<% }); %>
					</div>
				</div>
			</div>
		</div>
	</div>
	<span id='userJSON' hidden>
    <%= JSON.stringify(users); %>
	</span>

	<script>
		
		var users = JSON.parse($('#userJSON').text());
		$('#userJSON').remove();
		//var users = <%= users %>;
		var user_self;
		console.log("LENFGTH, ",users.length);
		for(i = 0; i<users.length; i++){
			console.log("hii", users[i]); 
			if(users[i].id == localStorage.getItem('uid')){
				user_self = users[i];
				break;
			}
		}
//		users.forEach(myFunction); 
//		function myFunction(user, index) 
//		{ 
//			console.log(user); 
//			if(user.id == localStorage.getItem('uid')){
//				user_self = user;
//				break;
//			}
//		}		
//		users.forEach(function(user) {
//			if(user.id == localStorage.getItem('uid')){
//				user_self = user;
//				break;
//			}
//		});

		var ctx = document.getElementById('myChart').getContext('2d');
		var myChart = new Chart(ctx, {
			type: 'radar',
			data: {
				labels: ['acousticness', 'danceability', 'energy', 'instrumentalness', 'speechiness', 'valence'],
				datasets: [{
					label: "Your data",
					data: [user_self.top_tracks.agg_features.acousticness,
						   user_self.top_tracks.agg_features.danceability,
						   user_self.top_tracks.agg_features.energy,
						   user_self.top_tracks.agg_features.instrumentalness,
						   user_self.top_tracks.agg_features.speechiness,
						   user_self.top_tracks.agg_features.valence],
					
					backgroundColor: 'rgba(255, 99, 132, 0.2)',
					borderColor: 'rgba(255, 99, 132, 1)',
					borderWidth: 1
				}]
			},
			options: {
				scales: {
				}
			}
		});
	</script>
	
  <script>
    var users = "<%= users %>";
    function assignButtons() {
        var btns = document.getElementsByName("follow"); 
        for (n=0; n < btns.length; n++) {
            btns[n].id = String(n); 
        }
    }; 

    assignButtons();

    
    document.addEventListener('click', function (event) {

      if (event.target.id == '0') {
        console.log('clicked Orgil');
      }
      if (event.target.id == '1') {
        console.log('clicked Karen');
      }
      if (event.target.id == '2') {
        console.log('clicked Jen');
        console.log(typeof users);
        console.log(users.length);
        var token = "<%= access_token  %>";  
        var follow_req = {
          url: 'https://api.spotify.com/v1/me/following',
          headers: { 'Authorization': 'Bearer ' + access_token,
                    'Content-Type': 'application/json' },
          type: 'user',
          ids: '',
          json: true
        };

                
        // request.get(features_req, function(error, response, body) {
        //   var features = body;
        //   track_features.push(features);
        //   // add audio features for each of user's tracks to field 'audio_features'
        //   db.collection("users").doc(uid).update({
        //     audio_features: track_features
        //   }).then(function() {
        //     //console.log("User audio features updated " + uid);
        //   });
        // });
      
      }

      if (event.target.matches('.close')) {
        // Run your code to close a modal
      }

    }, false);
    
  </script>
	<!-- Bootstrap JS -->
	<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
	
	<script type="text/javascript" src="login.js"></script> 
</body>
</html>